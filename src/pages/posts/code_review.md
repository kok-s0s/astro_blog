---
layout: ../../layouts/Post.astro
title: 'Code Review 也是一门技术活'
pubDate: 2025-05-19
updatedDate: 2025-05-19
description: '即将成为三年工作经验的码仔，记录下一些 Code Review 环节强烈建议做的事情，在开发阶段严格自查，是最经济的投入，如果到了实际产品上线后才暴漏，危已危已。'
author: 'kok-s0s'
image:
  url: '/images/code_review/review.jpg'
  alt: 'Qt'
tags: ['Code Review']
---

## 多线程共享数据访问 Checklist

### 一、是否存在多线程访问？

| 检查项                             | 说明                                                         |
| ---------------------------------- | ------------------------------------------------------------ |
| 是否有多个线程访问同一变量/数据？  | 比如定时器、回调函数、后台线程等                             |
| 是否有跨线程信号/槽连接？          | 非默认连接类型，如 `Qt` 中的 `QueuedConnection` 会跨线程触发 |
| 是否涉及全局对象、单例或共享引用？ | 容易被多个线程同时读写                                       |

### 二、是否有并发读写？

| 检查项                             | 说明                                           |
| ---------------------------------- | ---------------------------------------------- |
| 是否存在一个线程写、另一个线程读？ | 即使写入频率不高，也有风险                     |
| 是否对容器进行添加/删除操作？      | 如 append、remove、insert 都属于修改操作       |
| 是否使用了非线程安全的数据结构？   | Qt 容器（QList, QVector 等）默认不是线程安全的 |

### 三、是否做了同步保护？

| 检查项                              | 说明                                 |
| ----------------------------------- | ------------------------------------ |
| 是否使用锁机制保护共享数据？        | 如 QMutex、QReadWriteLock 等         |
| 锁是否作用在整个访问/修改操作区域？ | 尤其是多行操作时，必须全包住         |
| 是否使用了自动锁（RAII）？          | 避免忘记 unlock（例如 QMutexLocker） |
| 是否避免在锁内做耗时操作？          | 避免死锁、卡界面                     |

### 四、结构是否合理可扩展？

| 检查项                                       | 说明                                                      |
| -------------------------------------------- | --------------------------------------------------------- |
| 是否将锁作为成员变量，保护整个资源生命周期？ | 保证资源和锁是强绑定的                                    |
| 是否需要封装线程安全容器？                   | 如 ThreadSafeQueue、ThreadSafeMap 等                      |
| 是否设计了线程通信机制？                     | 如条件变量、线程安全队列、事件派发机制等                  |
| 是否需要将工作逻辑放入单独线程？             | 利用 `QThread`、任务队列、信号/槽通信更清晰地解耦线程逻辑 |

### 五、是否有测试或监控机制？

| 检查项                                | 说明                                   |
| ------------------------------------- | -------------------------------------- |
| 是否使用断言或日志检测异常访问？      | 加入一致性检查，发现边界情况           |
| 是否在 debug 模式下主动测试线程交叉？ | 强化测试不同线程交互顺序，发现潜在问题 |
| 是否出现过偶现崩溃、未定义行为？      | 若是，很大可能是线程安全问题导致的     |

### 其它实际建议

- 在代码注释或 PR Review 中标注“此处涉及多线程访问，已加锁”。
- 出现崩溃/偶现 bug 时，特别是访问数据内存相关的，可优先回顾是否涉及多线程共享数据访问。
